import K from"./katex-DsmCZfJr.js";import{ad as y,ae as Q,F as tt,C as et,j as W,af as R,Z as X,ag as nt,ah as rt,v as at,N as it,ai as ot,aj as ut,ak as lt,al as st,a5 as V,a4 as ht}from"./MilkdownEditor-BItiUuSt.js";import{c as ct}from"./confirm-DtE-HkVd-CQtly_A8.js";import{m as H,a as mt}from"./inline-latex-C9IGAXXQ-C8Lvg3-4.js";import{k as O,c as pt,a as dt,h as _}from"./index-C5Q1Okh6.js";import{d as wt}from"./index-JZOxkznV.js";import{t as xt,T as ft}from"./index-BBd_3295.js";import{I as kt}from"./index-C2bBFYD5.js";import"./index.dom-C3-224fz.js";import"./mutex-yV3mxE7x.js";import"./purify.es-CUZqrfXr.js";function gt(){return{enter:{mathFlow:t,mathFlowFenceMeta:e,mathText:l},exit:{mathFlow:r,mathFlowFence:n,mathFlowFenceMeta:a,mathFlowValue:h,mathText:s,mathTextData:h}};function t(i){const c={type:"element",tagName:"code",properties:{className:["language-math","math-display"]},children:[]};this.enter({type:"math",meta:null,value:"",data:{hName:"pre",hChildren:[c]}},i)}function e(){this.buffer()}function a(){const i=this.resume(),c=this.stack[this.stack.length-1];y(c.type==="math"),c.meta=i}function n(){this.data.mathFlowInside||(this.buffer(),this.data.mathFlowInside=!0)}function r(i){const c=this.resume().replace(/^(\r?\n|\r)|(\r?\n|\r)$/g,""),m=this.stack[this.stack.length-1];y(m.type==="math"),this.exit(i),m.value=c;const p=m.data.hChildren[0];y(p.type==="element"),y(p.tagName==="code"),p.children.push({type:"text",value:c}),this.data.mathFlowInside=void 0}function l(i){this.enter({type:"inlineMath",value:"",data:{hName:"code",hProperties:{className:["language-math","math-inline"]},hChildren:[]}},i),this.buffer()}function s(i){const c=this.resume(),m=this.stack[this.stack.length-1];y(m.type==="inlineMath"),this.exit(i),m.value=c,m.data.hChildren.push({type:"text",value:c})}function h(i){this.config.enter.data.call(this,i),this.config.exit.data.call(this,i)}}function Mt(t){let e=(t||{}).singleDollarTextMath;return e==null&&(e=!0),n.peek=r,{unsafe:[{character:"\r",inConstruct:"mathFlowMeta"},{character:`
`,inConstruct:"mathFlowMeta"},{character:"$",after:e?void 0:"\\$",inConstruct:"phrasing"},{character:"$",inConstruct:"mathFlowMeta"},{atBreak:!0,character:"$",after:"\\$"}],handlers:{math:a,inlineMath:n}};function a(l,s,h,i){const c=l.value||"",m=h.createTracker(i),p="$".repeat(Math.max(Q(c,"$")+1,2)),f=h.enter("mathFlow");let w=m.move(p);if(l.meta){const x=h.enter("mathFlowMeta");w+=m.move(h.safe(l.meta,{after:`
`,before:w,encode:["$"],...m.current()})),x()}return w+=m.move(`
`),c&&(w+=m.move(c+`
`)),w+=m.move(p),f(),w}function n(l,s,h){let i=l.value||"",c=1;for(e||c++;new RegExp("(^|[^$])"+"\\$".repeat(c)+"([^$]|$)").test(i);)c++;const m="$".repeat(c);/[^ \r\n]/.test(i)&&(/^[ \r\n]/.test(i)&&/[ \r\n]$/.test(i)||/^\$|\$$/.test(i))&&(i=" "+i+" ");let p=-1;for(;++p<h.unsafe.length;){const f=h.unsafe[p];if(!f.atBreak)continue;const w=h.compilePattern(f);let x;for(;x=w.exec(i);){let u=x.index;i.codePointAt(u)===10&&i.codePointAt(u-1)===13&&u--,i=i.slice(0,u)+" "+i.slice(x.index+1)}}return m+i+m}function r(){return"$"}}function F(t){return t!==null&&t<-2}function D(t){return t===-2||t===-1||t===32}function $(t,e,a,n){const r=n?n-1:Number.POSITIVE_INFINITY;let l=0;return s;function s(i){return D(i)?(t.enter(a),h(i)):e(i)}function h(i){return D(i)&&l++<r?(t.consume(i),h):(t.exit(a),e(i))}}const Ft={tokenize:vt,concrete:!0,name:"mathFlow"},A={tokenize:yt,partial:!0};function vt(t,e,a){const n=this,r=n.events[n.events.length-1],l=r&&r[1].type==="linePrefix"?r[2].sliceSerialize(r[1],!0).length:0;let s=0;return h;function h(o){return t.enter("mathFlow"),t.enter("mathFlowFence"),t.enter("mathFlowFenceSequence"),i(o)}function i(o){return o===36?(t.consume(o),s++,i):s<2?a(o):(t.exit("mathFlowFenceSequence"),$(t,c,"whitespace")(o))}function c(o){return o===null||F(o)?p(o):(t.enter("mathFlowFenceMeta"),t.enter("chunkString",{contentType:"string"}),m(o))}function m(o){return o===null||F(o)?(t.exit("chunkString"),t.exit("mathFlowFenceMeta"),p(o)):o===36?a(o):(t.consume(o),m)}function p(o){return t.exit("mathFlowFence"),n.interrupt?e(o):t.attempt(A,f,S)(o)}function f(o){return t.attempt({tokenize:Z,partial:!0},S,w)(o)}function w(o){return(l?$(t,x,"linePrefix",l+1):x)(o)}function x(o){return o===null?S(o):F(o)?t.attempt(A,f,S)(o):(t.enter("mathFlowValue"),u(o))}function u(o){return o===null||F(o)?(t.exit("mathFlowValue"),x(o)):(t.consume(o),u)}function S(o){return t.exit("mathFlow"),e(o)}function Z(o,G,N){let P=0;return $(o,j,"linePrefix",n.parser.constructs.disable.null.includes("codeIndented")?void 0:4);function j(k){return o.enter("mathFlowFence"),o.enter("mathFlowFenceSequence"),L(k)}function L(k){return k===36?(P++,o.consume(k),L):P<s?N(k):(o.exit("mathFlowFenceSequence"),$(o,J,"whitespace")(k))}function J(k){return k===null||F(k)?(o.exit("mathFlowFence"),G(k)):N(k)}}}function yt(t,e,a){const n=this;return r;function r(s){return s===null?e(s):(t.enter("lineEnding"),t.consume(s),t.exit("lineEnding"),l)}function l(s){return n.parser.lazy[n.now().line]?a(s):e(s)}}function Ct(t){let a=(t||{}).singleDollarTextMath;return a==null&&(a=!0),{tokenize:n,resolve:Tt,previous:Et,name:"mathText"};function n(r,l,s){let h=0,i,c;return m;function m(u){return r.enter("mathText"),r.enter("mathTextSequence"),p(u)}function p(u){return u===36?(r.consume(u),h++,p):h<2&&!a?s(u):(r.exit("mathTextSequence"),f(u))}function f(u){return u===null?s(u):u===36?(c=r.enter("mathTextSequence"),i=0,x(u)):u===32?(r.enter("space"),r.consume(u),r.exit("space"),f):F(u)?(r.enter("lineEnding"),r.consume(u),r.exit("lineEnding"),f):(r.enter("mathTextData"),w(u))}function w(u){return u===null||u===32||u===36||F(u)?(r.exit("mathTextData"),f(u)):(r.consume(u),w)}function x(u){return u===36?(r.consume(u),i++,x):i===h?(r.exit("mathTextSequence"),r.exit("mathText"),l(u)):(c.type="mathTextData",w(u))}}}function Tt(t){let e=t.length-4,a=3,n,r;if((t[a][1].type==="lineEnding"||t[a][1].type==="space")&&(t[e][1].type==="lineEnding"||t[e][1].type==="space")){for(n=a;++n<e;)if(t[n][1].type==="mathTextData"){t[e][1].type="mathTextPadding",t[a][1].type="mathTextPadding",a+=2,e-=2;break}}for(n=a-1,e++;++n<=e;)r===void 0?n!==e&&t[n][1].type!=="lineEnding"&&(r=n):(n===e||t[n][1].type==="lineEnding")&&(t[r][1].type="mathTextData",n!==r+2&&(t[r][1].end=t[n-1][1].end,t.splice(r+2,n-r-2),e-=n-r-2,n=r+2),r=void 0);return t}function Et(t){return t!==36||this.events[this.events.length-1][1].type==="characterEscape"}function St(t){return{flow:{36:Ft},text:{36:Ct(t)}}}const _t={};function $t(t){const e=this,a=t||_t,n=e.data(),r=n.micromarkExtensions||(n.micromarkExtensions=[]),l=n.fromMarkdownExtensions||(n.fromMarkdownExtensions=[]),s=n.toMarkdownExtensions||(n.toMarkdownExtensions=[]);r.push(St(a)),l.push(gt()),s.push(Mt(a))}const It=X.extendSchema(t=>e=>{const a=t(e);return{...a,toMarkdown:{match:a.toMarkdown.match,runner:(n,r)=>{var l,s;if(((l=r.attrs.language)!=null?l:"").toLowerCase()==="latex")n.addNode("math",void 0,((s=r.content.firstChild)==null?void 0:s.text)||"");else return a.toMarkdown.runner(n,r)}}}}),B=xt("INLINE_LATEX"),zt=dt({props:{config:{type:Object,required:!0},innerView:{type:Object,required:!0},updateValue:{type:Object,required:!0}},setup(t){const e=n=>{if(!(!n||!(n instanceof HTMLElement))){for(;n.firstChild;)n.removeChild(n.firstChild);t.innerView.value&&n.appendChild(t.innerView.value.dom)}},a=n=>{n.preventDefault(),t.updateValue.value()};return()=>{var n,r;return _("div",{class:"container"},t.innerView&&_("div",{ref:e}),_("button",{onPointerdown:a},_(kt,{icon:(r=(n=t.config).inlineEditConfirm)==null?void 0:r.call(n)})))}}});var U=t=>{throw TypeError(t)},Y=(t,e,a)=>e.has(t)||U("Cannot "+a),d=(t,e,a)=>(Y(t,e,"read from private field"),a?a.call(t):e.get(t)),g=(t,e,a)=>e.has(t)?U("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,a),I=(t,e,a,n)=>(Y(t,e,"write to private field"),e.set(t,a),a),C,v,z,M,T,E,b,q;class bt{constructor(e,a,n){this.ctx=e,g(this,C),g(this,v),g(this,z),g(this,M,O(null)),g(this,T,O(()=>{})),g(this,E),g(this,b,()=>{d(this,M).value&&(d(this,M).value.destroy(),d(this,M).value=null)}),g(this,q,l=>{const h=(()=>{const{selection:i,schema:c}=l.state;if(i.empty||!(i instanceof it))return!1;const m=i.node;if(m.type.name!==mt)return!1;const p=i.from,f=c.nodes.paragraph.create(null,c.text(m.attrs.value)),w=new ot(d(this,z),{state:ut.create({doc:f,schema:new st({nodes:{doc:{content:"block+"},paragraph:{content:"inline*",group:"block",parseDOM:[{tag:"p"}],toDOM(){return["p",0]}},text:{group:"inline"}}}),plugins:[lt({"Mod-z":ht,"Mod-Z":V,"Mod-y":V,Enter:()=>(d(this,T).value(),!0)})]})});return d(this,M).value=w,d(this,T).value=()=>{const{tr:x}=l.state;x.setNodeAttribute(p,"value",w.state.doc.textContent),l.dispatch(x),requestAnimationFrame(()=>{l.focus()})},!0})();return h||d(this,b).call(this),h}),this.update=(l,s)=>{d(this,v).update(l,s)},this.destroy=()=>{d(this,E).unmount(),d(this,v).destroy(),d(this,C).remove()};const r=document.createElement("div");r.className="milkdown-latex-inline-edit",I(this,C,r),I(this,E,pt(zt,{config:n,innerView:d(this,M),updateValue:d(this,T)})),d(this,E).mount(r),I(this,v,new ft({debounce:0,content:d(this,C),shouldShow:d(this,q),offset:10,floatingUIOptions:{placement:"bottom"}})),d(this,v).update(a),I(this,z,document.createElement("div"))}}C=new WeakMap;v=new WeakMap;z=new WeakMap;M=new WeakMap;T=new WeakMap;E=new WeakMap;b=new WeakMap;q=new WeakMap;const qt=R(t=>nt(/(?:\$)([^$]+)(?:\$)$/,H.type(t),{getAttr:e=>{var a;return{value:(a=e[1])!=null?a:""}}})),Nt=R(t=>rt(/^\$\$[\s\n]$/,X.type(t),()=>({language:"LaTeX"}))),Pt=W("remarkMath",()=>$t);function Lt(t){return at(t,"math",(e,a,n)=>{const{value:r}=e,l={type:"code",lang:"LaTeX",value:r};n.children.splice(a,1,l)})}const Vt=W("remarkMathBlock",()=>()=>Lt),jt=(t,e)=>{t.config(a=>{if(!a.get(tt).includes(et.CodeMirror))throw new Error("You need to enable CodeMirror to use LaTeX feature");a.update(wt.key,l=>({...l,renderPreview:(s,h)=>{if(s.toLowerCase()==="latex"&&h.length>0)return Ot(h,e?.katexOptions);const i=l.renderPreview;return i(s,h)}})),a.set(B.key,{view:l=>{var s;return new bt(a,l,{inlineEditConfirm:(s=e?.inlineEditConfirm)!=null?s:()=>ct,...e})}})}).use(Pt).use(Vt).use(H).use(B).use(qt).use(Nt).use(It)};function Ot(t,e){return K.renderToString(t,{...e,throwOnError:!1,displayMode:!0})}export{jt as defineFeature};
