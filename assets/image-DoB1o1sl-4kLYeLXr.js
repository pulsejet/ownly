import{$ as V,j as z,d as Z,g as W,k as Y,v as G}from"./MilkdownEditor-BItiUuSt.js";import{p as R,c as N}from"./purify.es-CUZqrfXr.js";import{j as K,r as m,c as J,a as j,g as Q,h as n,F as X}from"./index-C5Q1Okh6.js";var ee=Object.defineProperty,S=Object.getOwnPropertySymbols,te=Object.prototype.hasOwnProperty,re=Object.prototype.propertyIsEnumerable,T=(e,t,r)=>t in e?ee(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,ae=(e,t)=>{for(var r in t||(t={}))te.call(t,r)&&T(e,r,t[r]);if(S)for(var r of S(t))re.call(t,r)&&T(e,r,t[r]);return e};function C(e,t){return Object.assign(e,{meta:ae({package:"@milkdown/components"},t)}),e}const oe={imageIcon:()=>"ðŸŒŒ",captionIcon:()=>"ðŸ’¬",uploadButton:()=>"Upload file",confirmButton:()=>"Confirm âŽ",uploadPlaceholderText:"or paste the image link ...",captionPlaceholderText:"Image caption",onUpload:e=>Promise.resolve(URL.createObjectURL(e))},x=V(oe,"imageBlockConfigCtx");C(x,{displayName:"Config<image-block>",group:"ImageBlock"});function ne(e){return G(e,"paragraph",(t,r,u)=>{var p,s;if(((p=t.children)==null?void 0:p.length)!==1)return;const h=(s=t.children)==null?void 0:s[0];if(!h||h.type!=="image")return;const{url:v,alt:_,title:y}=h,d={type:"image-block",url:v,alt:_,title:y};u.children.splice(r,1,d)})}const L=z("remark-image-block",()=>()=>ne);C(L.plugin,{displayName:"Remark<remarkImageBlock>",group:"ImageBlock"});C(L.options,{displayName:"RemarkConfig<remarkImageBlock>",group:"ImageBlock"});var ie=Object.defineProperty,A=Object.getOwnPropertySymbols,le=Object.prototype.hasOwnProperty,ce=Object.prototype.propertyIsEnumerable,H=(e,t,r)=>t in e?ie(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,se=(e,t)=>{for(var r in t||(t={}))le.call(t,r)&&H(e,r,t[r]);if(A)for(var r of A(t))ce.call(t,r)&&H(e,r,t[r]);return e};const q="image-block",E=Z("image-block",()=>({inline:!1,group:"block",selectable:!0,draggable:!0,isolating:!0,marks:"",atom:!0,priority:100,attrs:{src:{default:"",validate:"string"},caption:{default:"",validate:"string"},ratio:{default:1,validate:"number"}},parseDOM:[{tag:`img[data-type="${q}"]`,getAttrs:e=>{var t;if(!(e instanceof HTMLElement))throw Y(e);return{src:e.getAttribute("src")||"",caption:e.getAttribute("caption")||"",ratio:Number((t=e.getAttribute("ratio"))!=null?t:1)}}}],toDOM:e=>["img",se({"data-type":q},e.attrs)],parseMarkdown:{match:({type:e})=>e==="image-block",runner:(e,t,r)=>{const u=t.url,p=t.title;let s=Number(t.alt||1);(Number.isNaN(s)||s===0)&&(s=1),e.addNode(r,{src:u,caption:p,ratio:s})}},toMarkdown:{match:e=>e.type.name==="image-block",runner:(e,t)=>{e.openNode("paragraph"),e.addNode("image",void 0,void 0,{title:t.attrs.caption,url:t.attrs.src,alt:`${Number.parseFloat(t.attrs.ratio).toFixed(2)}`}),e.closeNode()}}}));C(E.node,{displayName:"NodeSchema<image-block>",group:"ImageBlock"});function B({icon:e,class:t,onClick:r}){return n("span",{class:N("milkdown-icon",t),onPointerdown:r,ref:u=>{u&&e&&(u.innerHTML=R.sanitize(e.trim()))}})}B.props={icon:{type:String,required:!1},class:{type:String,required:!1},onClick:{type:Function,required:!1}};const ue=K("abcdefg",8),pe=j({props:{src:{type:Object,required:!0},selected:{type:Object,required:!0},readonly:{type:Object,required:!0},setLink:{type:Function,required:!0},imageIcon:{type:String,required:!1},uploadButton:{type:String,required:!1},confirmButton:{type:String,required:!1},uploadPlaceholderText:{type:String,required:!1},onUpload:{type:Function,required:!0}},setup({readonly:e,src:t,setLink:r,onUpload:u,imageIcon:p,uploadButton:s,confirmButton:h,uploadPlaceholderText:v,className:_}){var y,d;const k=m(!1),f=m(),O=m((y=t.value)!=null?y:""),P=m(ue()),w=m(((d=t.value)==null?void 0:d.length)!==0),l=o=>{const g=o.target.value;w.value=g.length!==0,O.value=g},b=o=>{var i,g;o.key==="Enter"&&r((g=(i=f.value)==null?void 0:i.value)!=null?g:"")},a=()=>{var o,i;r((i=(o=f.value)==null?void 0:o.value)!=null?i:"")},c=o=>{var i;const g=(i=o.target.files)==null?void 0:i[0];g&&u(g).then(I=>{I&&(r(I),w.value=!0)}).catch(I=>{console.error("An error occurred while uploading image"),console.error(I)})};return()=>n("div",{class:N("image-edit",_)},n(B,{icon:p,class:"image-icon"}),n("div",{class:N("link-importer",k.value&&"focus")},n("input",{ref:f,draggable:"true",onDragstart:o=>{o.preventDefault(),o.stopPropagation()},disabled:e.value,class:"link-input-area",value:O.value,onInput:l,onKeydown:b,onFocus:()=>k.value=!0,onBlur:()=>k.value=!1}),!w.value&&n("div",{class:"placeholder"},n("input",{disabled:e.value,class:"hidden",id:P.value,type:"file",accept:"image/*",onChange:c}),n("label",{class:"uploader",for:P.value},n(B,{icon:s})),n("span",{class:"text",onClick:()=>{var o;return(o=f.value)==null?void 0:o.focus()}},v))),O.value&&n("div",{class:"confirm",onClick:()=>a()},n(B,{icon:h})))}}),de=j({props:{src:{type:Object,required:!0},caption:{type:Object,required:!0},ratio:{type:Object,required:!0},selected:{type:Object,required:!0},readonly:{type:Object,required:!0},setAttr:{type:Function,required:!0},config:{type:Object,required:!0}},setup({src:e,caption:t,ratio:r,readonly:u,setAttr:p,config:s}){var h;const v=m(),_=m(),y=m(!!((h=t.value)!=null&&h.length)),d=m(0),k=()=>{var a;const c=v.value;if(!c)return;const o=c.closest(".milkdown-image-block");if(!o)return;const i=o.getBoundingClientRect().width;if(!i)return;const g=c.height,I=c.width,$=I<i?g:i*(g/I),F=($*((a=r.value)!=null?a:1)).toFixed(2);c.dataset.origin=$.toFixed(2),c.dataset.height=F,c.style.height=`${F}px`},f=a=>{a.preventDefault(),a.stopPropagation(),!u.value&&(y.value=!y.value)},O=a=>{const o=a.target.value;d.value&&window.clearTimeout(d.value),d.value=window.setTimeout(()=>{p("caption",o)},1e3)},P=a=>{const o=a.target.value;d.value&&(window.clearTimeout(d.value),d.value=0),p("caption",o)},w=a=>{a.preventDefault();const c=v.value;if(!c)return;const o=c.getBoundingClientRect().top,i=a.clientY-o,g=Number(i<100?100:i).toFixed(2);c.dataset.height=g,c.style.height=`${g}px`},l=()=>{window.removeEventListener("pointermove",w),window.removeEventListener("pointerup",l);const a=v.value;if(!a)return;const c=Number(a.dataset.origin),o=Number(a.dataset.height),i=Number.parseFloat(Number(o/c).toFixed(2));Number.isNaN(i)||p("ratio",i)},b=a=>{u.value||(a.preventDefault(),a.stopPropagation(),window.addEventListener("pointermove",w),window.addEventListener("pointerup",l))};return()=>n(X,null,n("div",{class:"image-wrapper"},n("div",{class:"operation"},n("div",{class:"operation-item",onPointerdown:f},n(B,{icon:s.captionIcon()}))),n("img",{ref:v,"data-type":q,onLoad:k,src:e.value,alt:t.value}),n("div",{ref:_,class:"image-resize-handle",onPointerdown:b})),y.value&&n("input",{draggable:"true",onDragstart:a=>{a.preventDefault(),a.stopPropagation()},class:"caption-input",placeholder:s?.captionPlaceholderText,onInput:O,onBlur:P,value:t.value}))}});var ge=Object.defineProperty,D=Object.getOwnPropertySymbols,me=Object.prototype.hasOwnProperty,ve=Object.prototype.propertyIsEnumerable,M=(e,t,r)=>t in e?ge(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,fe=(e,t)=>{for(var r in t||(t={}))me.call(t,r)&&M(e,r,t[r]);if(D)for(var r of D(t))ve.call(t,r)&&M(e,r,t[r]);return e};const he=j({props:{src:{type:Object,required:!0},caption:{type:Object,required:!0},ratio:{type:Object,required:!0},selected:{type:Object,required:!0},readonly:{type:Object,required:!0},setAttr:{type:Function,required:!0},config:{type:Object,required:!0}},setup(e){const{src:t}=e;return()=>{var r;return(r=t.value)!=null&&r.length?n(de,fe({},e)):n(pe,{src:e.src,selected:e.selected,readonly:e.readonly,setLink:u=>e.setAttr("src",u),imageIcon:e.config.imageIcon(),uploadButton:e.config.uploadButton(),confirmButton:e.config.confirmButton(),uploadPlaceholderText:e.config.uploadPlaceholderText,onUpload:e.config.onUpload})}}}),U=W(E.node,e=>(t,r,u)=>{const p=m(t.attrs.src),s=m(t.attrs.caption),h=m(t.attrs.ratio),v=m(!1),_=m(!r.editable),y=(l,b)=>{const a=u();a!=null&&r.dispatch(r.state.tr.setNodeAttribute(a,l,l==="src"?R.sanitize(b):b))},d=e.get(x.key),k=J(he,{src:p,caption:s,ratio:h,selected:v,readonly:_,setAttr:y,config:d}),f=document.createElement("div");f.className="milkdown-image-block",k.mount(f);const O=Q(()=>{v.value?f.classList.add("selected"):f.classList.remove("selected")}),P=d.proxyDomURL,w=l=>{if(!P)p.value=l.attrs.src;else{const b=P(l.attrs.src);typeof b=="string"?p.value=b:b.then(a=>{p.value=a}).catch(console.error)}h.value=l.attrs.ratio,s.value=l.attrs.caption,_.value=!r.editable};return w(t),{dom:f,update:l=>l.type!==t.type?!1:(w(l),!0),stopEvent:l=>l.target instanceof HTMLInputElement,selectNode:()=>{v.value=!0},deselectNode:()=>{v.value=!1},destroy:()=>{O(),k.unmount(),f.remove()}}});C(U,{displayName:"NodeView<image-block>",group:"ImageBlock"});const _e=[L,E,U,x].flat(),ke=`
  <svg
    xmlns="http://www.w3.org/2000/svg"
    width="24"
    height="24"
    viewBox="0 0 24 24"
  >
    <g clip-path="url(#clip0_977_8075)">
      <path
        d="M19 5V19H5V5H19ZM19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19V5C21 3.9 20.1 3 19 3ZM14.14 11.86L11.14 15.73L9 13.14L6 17H18L14.14 11.86Z"
      />
    </g>
    <defs>
      <clipPath id="clip0_977_8075">
        <rect width="24" height="24" />
      </clipPath>
    </defs>
  </svg>
`;export{x as a,_e as b,E as c,ke as i};
